<!DOCTYPE html>
<html>

	<head>
		<!--[if lt IE 9]>
    <script type="text/javascript" src="static/js/html5.js"></script>
    <![endif]-->
		<meta charset="utf-8">
		<link rel="icon" href="static/favicon.ico" type="image/x-icon"/>
		<meta name="renderer" content="webkit" /> 
		<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="format-detection" content="telephone=no">
		<title>CPU知识云</title>
		<meta name="keywords" content="">
		<meta name="description" content="">
		<script type="text/javascript" src="static/js/jquery.min.js"></script>
		<script type="text/javascript" src="static/js/vue_2.5.13.js"></script>
		<script type="text/javascript" src="static/js/jquerysession.js"></script>
		<script type="text/javascript" src="static/js/jquery.params.js"></script>
		<script type="text/javascript" src="static/js/common.js"></script>
		<script type="text/javascript" src="static/js/qrcode.js"></script>
		<link rel="stylesheet" type="text/css" href="static/css/animate.css">
		<link rel="stylesheet" type="text/css" href="static/css/global.css">
		<link rel="stylesheet" type="text/css" href="static/css/style.css">
		<link rel="stylesheet" type="text/css" href="static/css/orderstyle.css">
		<link rel="stylesheet" type="text/css" href="static/css/owl.carousel.min.css">
		<script type="text/javascript" src="static/js/owl.carousel.js"></script>
		<script type="text/javascript" src="static/js/main.js"></script>

	</head>

	<body>
		<div id="all">
			<!-------------------------------------- 头部开始 -------------------------------------->
			<div class="header">
				<div class="head" id="head">
					<div class="wrap"> <span>欢迎访问CPU知识云，联合网络数字图书馆视频知识库！</span>
						<div class="frt">
							<ul>
								<li>
									<a href="popupsignin.html" v-if="!userinfo.nick_name"><span>登录</span></a>
									<a href="#" v-if="userinfo.nick_name" v-text="userinfo.nick_name"><span></span></a>

								</li>
								<li>
									<a href="popupsignin.html?p=1" v-if="!userinfo.nick_name"><span>注册</span></a>
									<a href="coursecenter.html" v-if="userinfo.nick_name"><span>个人中心</span></a>

								</li>
								<li>

									<a href="#" onclick="layout()" v-if="userinfo.nick_name"><span>退出</span></a>

								</li>
							</ul>
						</div>
						<div class="clear"></div>
					</div>
				</div>
				<div class="head2">
					<div class="wrap logoBox">
						<div class="logo flt">
							<a href="index.html"><img style="height: 70px;" src="static/picture/16.png"></a>
						</div>
						<div class="frt tel">
							<h3>cpuzsy@126.com
</h3>
							<p style="text-align: center;">24小时在线服务邮箱</p>
						</div>
					</div>
				</div>
				<div class="menu">
					<div class="wrap">
						<ul>
							<li class='on'>
								<a href="index.html">首页
									<label></label>
								</a>
							</li>

							<li>
								<a href="course.html">直击中考·
									<label style="font-size:10px;">学生版</label>
								</a>
							</li>
							<li>
								<a href="courseT.html">直击中考·
									<label style="font-size:10px;">教师版</label>
								</a>
							</li>
							<li>
								<a href="courseZ.html">直击中考·
									<label style="font-size:10px;">试题版</label>
								</a>
							</li>
							<li>
								<a href="news.html">直击中考 ·
									<label style="font-size:10px;">快讯</label>
								</a>
							</li>
						</ul>
					</div>
					<div class="menu_wrap"></div>
					<div class="clear"></div>
				</div>
			</div>

			<!-------------------------------------- 头部结束 -------------------------------------->
			<!-------------------------------------- 内容开始 -------------------------------------->
			<!--class="animated fast" data-animation="fadeInDown"-->
			<div class="mainer" id="grzx">
				<div class="page_list">
					<div class="page page3">
						<div class="wrap">

							<section class="aui-flexView">
								<header class="aui-navBar aui-navBar-fixed">
									<a href="javascript:;" class="aui-navBar-item">
										<i class="icon icon-return"></i>
									</a>
									<div class="aui-center">
										<span class="aui-center-title">订单详情</span>
									</div>
									<a href="javascript:;" class="aui-navBar-item">
										<i class="icon icon-sys"></i>
									</a>
								</header>
								<section class="aui-scrollView">
									<div class="aui-flex aui-flex-context">
										<div class="aui-flex-box">
											<h2>下单成功</h2>
											<h3>付款成功后，在<span style="font-size: 15px;">个人中心</span>学习课程</h3>
										</div>
										<div class="aui-assemble-img">

										</div>
									</div>

									<div class="divHeight"></div>
									<div class="aui-flex">
										<span style="font-size: 20px;">

											微信扫码支付:

										</span>
										<div id="ddsc" style="padding-left: 20px; font-size: 20px;">支付订单生成中...</div>
										<div id="qrcode" style="width:200px; height:200px; margin-top:15px;float: left;padding-left: 20px;"></div>

									</div>
									<div class="aui-flex b-line">

										<div class="aui-flex-box">
											<h5>课程列表</h5>
										</div>
										<div class="aui-address-arrow"></div>
									</div>
									<!--订单列表-->
									<div v-for="(course, idx) in courselist" :key="idx">
										<div class="aui-flex aui-flex-four">
											<div class="aui-flex-add">
												<img :src="course.image" alt="">
											</div>
											<div class="aui-flex-box">
												<p v-text="course.name"></p>
												<p class="b-line" style="color:#999"> 共1件</p>
											</div>
										</div>
										<div class="aui-flex aui-flex-four" style="padding-top:0">
											<div class="aui-flex-box">

												<button class="aui-btn-line" @click="window.location.href ='detail.html?id=' + course.id">课程详情</button>
											</div>
										</div>
									</div>
									<div class="aui-flex b-line">
										<div class="aui-flex-box">
											<h6>需付款: ￥<em v-text="pirce">1</em> <i>(扫码支付)</i></h6>
										</div>
									</div>

									<div class="divHeight"></div>

								</section>
							</section>

							<div class="clear"></div>
						</div>
					</div>
					<div class="ht100"></div>
					<div class="page page8">
						<img src="static/picture/bottomBg.jpg" style="width: 100%;" />
					</div>
				</div>
			</div>
			<!-------------------------------------- 内容结束 -------------------------------------->
			<!-------------------------------------- 尾部开始 -------------------------------------->
			<div class="footer">
				<div class="foot2">
					<p>Copyright &copy;2020 山西图联科技信息有限公司 版权所有 备案号：晋ICP备12002112号-1</p>
				</div>
			</div>
		</div>
		<!-------------------------------------- 尾部结束 -------------------------------------->

		<style>
			dl {
				margin-bottom: 10px;
			}
			
			dl dt {
				font-size: 16px;
				color: #333333;
				font-family: "microsoft yahei";
				font-weight: 600;
				padding: 15px 0px 5px 26px;
			}
			
			dd {
				font-family: "microsoft yahei", 宋体, Arial, Helvetica;
				font-size: 12px;
				color: rgb(51, 51, 51);
				line-height: 1.5;
			}
			
			dl dd p {
				padding: 5px 26px;
				line-height: 1.7!important;
				margin: 0;
			}
			
			dl dd p a {
				color: #666666;
				font-size: 14px;
				font-family: "microsoft yahei";
				display: block;
			}
			
			img {
				border: 0;
				outline-width: 0px;
				vertical-align: top;
			}
			
			.cusName {
				width: 600px;
				float: left;
				margin: 10px;
			}
			
			.cusName p {
				line-height: 40px;
				height: 40px;
				font-size: 16px;
				color: #333;
				font-family: "microsoft yahei";
				padding: 0;
				word-wrap: break-word;
				overflow: hidden;
			}
			
			.cusName span {
				line-height: 40px;
				height: 40px;
				position: relative;
				font-size: 14px;
				color: #666;
				font-family: "microsoft yahei";
				display: block;
				word-wrap: break-word;
				overflow: hidden;
			}
			
			.cus01 {
				height: 170px;
				padding: 0px 20px;
				border-bottom: 1px solid #000000;
			}
			
			.cusImg {
				width: 127px;
				height: 127px;
				overflow: hidden;
				margin: 10px;
				float: left;
			}
		</style>
		<script>
			window.onbeforeunload = function(e) {
				if(ifFK == 0) {
					removeOrder(orderCode);
				}
			};

			var userInfo = {};
			userInfo.nike_name = "";
			if($.session.get('user') != undefined) {
				userInfo = JSON.parse($.session.get('user'));
			} else {
				window.location.href = "popupsignin.html";
			}
			var price;
			var orderCode = "";
			var cid;
			/*二维码*/
			var vm = new Vue({
				el: '#all',
				data: {
					userinfo: {},
					/*item: {},*/
					courselist: [],
					study: {},
					outTradeNo: "",
				},
				created: function() {
					this.getLM();
				},
				methods: {
					getLM: function() {
						//如果已经登录
						if(userInfo.nike_name != "") {
							this.userinfo = userInfo;
						} else {

						}
						cid = $.getUrlParam('cid');
						/*订单号生成*/
						orderCode = random_No(10);
						console.log(orderCode);
						/*如果是单个课程*/
						if(cid != null && cid != "other") {
							$.ajax({
								url: requestUrl + '/blade-cms/font/categoryDetail', //地址
								data: {
									id: cid
								},
								dataType: 'json', //数据类型
								type: 'GET', //类型
								timeout: 5000, //超时
								//请求成功
								success: function(data, status) {
									vm.courselist.push(data.data);
									vm.pirce = vm.courselist[0].pirce;
									price = parseFloat(vm.pirce) * 100;
									ifgm(cid, 0);

								},
								headers: {
									'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0'
								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									if(textStatus === 'timeout') {
										console.log("请求超时！");
									}
								}
							})

						}
						/*如果是套餐订购*/
						var cids = "";
						if(cid != null && cid == "other") {
							$.ajax({
								url: requestUrl + '/blade-cms/category/gouwuList', //地址
								data: {
									userId: userInfo.user_id
								},
								dataType: 'json', //数据类型
								type: 'GET', //类型
								timeout: 5000, //超时
								//请求成功
								success: function(data, status) {

									vm.courselist = data.data.records;
									if(vm.courselist.length == 0) {
										$.ajax({
											url: requestUrl + '/blade-cms/order/list', //地址
											dataType: 'json', //数据类型
											type: 'get', //类型
											data: {
												userId: userInfo.user_id,
												orderStatus: 0
											},
											timeout: 5000, //超时
											contentType: 'application/json',
											//请求成功
											success: function(data, status) {
												var list = data.data.records;
												if(list.length>0){
													ifgm(list[0].courseId, 0);
												}else{
													alert("已经购买，无需重复购买！");
												}
											},
											headers: {
												'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
												'Blade-Auth': 'bearer ' + userInfo.access_token

											},
											error: function(XMLHttpRequest, textStatus, errorThrown) {
												if(errorThrown == 'Unauthorized') {
													$.session.remove('user');
													alert("登录过期，请重新登录！");
													window.location.href = "popupsignin.html";
												}
											}
										})
								
									}else{
									var sumPrice = 0;
									for(var i = 0; i < data.data.records.length; i++) {
										sumPrice = sumPrice + parseFloat(data.data.records[i].pirce);
										cids += data.data.records[i].id + ",";
									}
									vm.pirce = sumPrice;
									price = parseFloat(vm.pirce) * 100;
									cid = data.data.records[0].id;
									ifgm(cids, 1);
									}
								},
								headers: {
									'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
									'Blade-Auth': 'bearer ' + userInfo.access_token

								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									if(errorThrown == 'Unauthorized') {
										$.session.remove('user');
										alert("登录过期，请重新登录！");
										window.location.href = "popupsignin.html";
									}
								}
							})

						}
						var outTradeNo = ""; //订单号
						for(var i = 0; i < 6; i++) //6位随机数，用以加在时间戳后面。
						{
							outTradeNo += Math.floor(Math.random() * 10);
						}
						outTradeNo = new Date().getTime() + outTradeNo; //时间戳，用来生成订单号。
						this.outTradeNo = outTradeNo;

					},
					getDetailHref: function(val) {
						return 'detail.html?id=' + val
					}
				},
				filters: {
					getOrderHref: function(val) {
						return 'courseorder.html?cid=' + val
					}
				}
			});
			var ifFK = 0;

			function getStatus(cid) {
				$.ajax({
					url: requestUrl + '/blade-cms/order/list', //地址
					dataType: 'json', //数据类型
					type: 'get', //类型
					data: {
						courseId: cid,
						userId: userInfo.user_id,
						ordernum: orderCode,
						orderStatus: 1
					},
					timeout: 5000, //超时
					contentType: 'application/json',
					//请求成功
					success: function(data, status) {
						var list = data.data.records;
						if(list.length == 0) {
							setTimeout("getStatus('" + cid + "')", 3000);
						} else {
							alert("付款成功！");
							ifFK = 1;
							window.location.href = "coursecenter.html";
						}
					},
					headers: {
						'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
						'Blade-Auth': 'bearer ' + userInfo.access_token

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						if(errorThrown == 'Unauthorized') {
							$.session.remove('user');
							alert("没有权限，请重新登录！");
							window.location.href = "popupsignin.html";
						}
					}
				})

			}

			function ifgm(cid, state) {
				$.ajax({
					url: requestUrl + '/blade-cms/order/list', //地址
					dataType: 'json', //数据类型
					type: 'get', //类型
					data: {
						courseId: cid,
						userId: userInfo.user_id
					},
					timeout: 5000, //超时
					contentType: 'application/json',
					//请求成功
					success: function(data, status) {
						var list = data.data.records;
						if(list.length == 0) {
							if(state == 0) {
								createOrder();
							}
							if(state == 1) {
								createPLOrder(cid);
							}
						} else {
							if(list[0].orderStatus == "1") {
								alert("已经购买，无需重复购买！");
							} else {
								var oNum = list[0].ordernum;
								removeOrder(oNum);
								alert("订单未支付已失效，请重新购买！");
								window.location.href = "detail.html?id=" + cid;
							}
						}
					},
					headers: {
						'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
						'Blade-Auth': 'bearer ' + userInfo.access_token

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {

						if(errorThrown == 'Unauthorized') {
							return false;
							$.session.remove('user');
							alert("没有权限，请重新登录！");
							window.location.href = "popupsignin.html";
						}
						return false;
					}
				})

			}
			/*批量订单生成*/
			function createPLOrder(cids) {
				var hashcode = '{"userId":\"' + userInfo.user_id + '\","ids":"' + cids + '\","ordernum":"' + orderCode + '\"}';
				/*console.log($.getUrlParam('cids'));*/
				$.ajax({
					url: requestUrl + '/blade-cms/order/addOrders', //地址
					dataType: 'json', //数据类型
					type: 'post', //类型
					data: hashcode,
					timeout: 2000, //超时
					contentType: 'application/json',
					//请求成功
					success: function(data, status) {
						/*生成支付二维码*/
						makeimg_();
					},
					headers: {
						'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
						'Blade-Auth': 'bearer ' + userInfo.access_token

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						if(errorThrown == 'Unauthorized') {
							$.session.remove('user');
							alert("登录过期，请重新登录！");
							window.location.href = "popupsignin.html";
						}
					}
				})
			}

			function createOrder() {
				var hashcode = '{"courseId":\"' + cid + '\","userId":\"' + userInfo.user_id + '\","ordernum":\"' + orderCode + '\"}';
				$.ajax({
					url: requestUrl + '/blade-cms/order/submit', //地址
					dataType: 'json', //数据类型
					type: 'post', //类型
					data: hashcode,
					timeout: 2000, //超时
					contentType: 'application/json',
					//请求成功
					success: function(data, status) {
						/*生成支付二维码*/
						makeimg_();
					},
					headers: {
						'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
						'Blade-Auth': 'bearer ' + userInfo.access_token

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						if(errorThrown == 'Unauthorized') {
							$.session.remove('user');
							alert("登录过期，请重新登录！");
							window.location.href = "popupsignin.html";
						}
					}
				})

			}
			/*生成二维码*/
			function makeimg_() {
				$.ajax({
					url: requestUrl + '/blade-cms/font/qcPay', //地址
					data: {
						productId: cid,
						subject: "CPU知识云支付订单",
						body: "CPU知识云支付订单",
						totalFee: price,
						outTradeNo: orderCode
					},
					dataType: 'json', //数据类型
					type: 'GET', //类型
					timeout: 5000, //超时
					//请求成功
					success: function(data, status) {
						console.log(data);
						var qrcode = new QRCode(document.getElementById("qrcode"), {
							width: 200,
							height: 200
						});
						console.log(data);
						//var url = 'https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx02111518672876176125cb3e1626759232&package=941981530&redirect_url='+'https://cpu.lhlib.vip';
						//window.location.href = url;
						//qrcode.makeCode(data.msg);
						$("#ddsc").hide();
						setTimeout("getStatus('" + cid + "')", 3000);

					},
					headers: {
						'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0'
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						if(textStatus === 'timeout') {
							console.log("请求超时！");
						}
					}
				})
			}

			function random_No(j) {
				var random_no = "";
				for(var i = 0; i < j; i++) //j位随机数，用以加在时间戳后面。
				{
					random_no += Math.floor(Math.random() * 10);
				}
				random_no = new Date().getTime() + random_no;
				return random_no;
			};

			function removeOrder(orderNum) {
				var hashcode = '{"ordernum":\"' + orderNum + '\"}';
				$.ajax({
					url: requestUrl + '/blade-cms/order/removeOrder', //地址
					dataType: 'json', //数据类型
					type: 'post', //类型
					data: hashcode,
					timeout: 2000, //超时
					contentType: 'application/json',
					//请求成功
					success: function(data, status) {
						/*console.log(data);*/
					},
					headers: {
						'Authorization': 'Basic c2FiZXI6c2FiZXJfc2VjcmV0',
						'Blade-Auth': 'bearer ' + userInfo.access_token

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						if(errorThrown == 'Unauthorized') {
							$.session.remove('user');
							alert("登录过期，请重新登录！");
							window.location.href = "popupsignin.html";
						}
					}
				})
			}
		</script>

	</body>

</html>